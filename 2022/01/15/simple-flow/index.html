<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>如何设计组件化流程引擎？ | simyy</title>
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="本文简单介绍下流程引擎以及实现一个最基础功能的组件化的流程引擎。">
<meta name="keywords" content="架构,流程引擎">
<meta property="og:type" content="article">
<meta property="og:title" content="如何设计组件化流程引擎？">
<meta property="og:url" content="http://simyy.cn/2022/01/15/simple-flow/index.html">
<meta property="og:site_name" content="simyy">
<meta property="og:description" content="本文简单介绍下流程引擎以及实现一个最基础功能的组件化的流程引擎。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://simyy.cn/images/simple-flow-1.jpeg">
<meta property="og:updated_time" content="2022-09-04T04:34:21.169Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="如何设计组件化流程引擎？">
<meta name="twitter:description" content="本文简单介绍下流程引擎以及实现一个最基础功能的组件化的流程引擎。">
<meta name="twitter:image" content="http://simyy.cn/images/simple-flow-1.jpeg">
  
    <link rel="alternative" href="/atom.xml" title="simyy" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head></html>
<script src="/js/hexo_resize_image.js"></script>
<body>
  <div id="container">
    <div class="mobile-nav-panel">
	<i class="icon-reorder icon-large"></i>
</div>
<header id="header">
	<h1 class="blog-title">
		<a href="/">simyy</a>
	</h1>
	<nav class="nav">
		<ul>
			<li><a href="/">主页</a></li><li><a href="/2014/07/07/book-list">书单</a></li><li><a href="/archives">归档</a></li><li><a href="/tags">标签</a></li>
			<li><a id="nav-search-btn" class="nav-icon" title="Search"></a></li>
			<li><a href="/atom.xml" id="nav-rss-link" class="nav-icon" title="RSS Feed"></a></li>
		</ul>
	</nav>
	<div id="search-form-wrap">
		<form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://simyy.cn"></form>
	</div>
</header>
    <!--div id="main"-->
      <div id="main">


<article id="post-simple-flow" class="post">
	<footer class="entry-meta-header">
		<span class="meta-elements date">
			<a href="/2022/01/15/simple-flow/" class="article-date">
  <time datetime="2022-01-15T03:58:57.000Z" itemprop="datePublished">2022-01-15</time>
</a>

		</span>
        <span class="tags">
	       	
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/架构/">架构</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/流程引擎/">流程引擎</a></li></ul>

		</span>
		<!--span class="meta-elements author">simyy</span-->
		<div class="commentscount">
			
		</div>
	</footer>
	
	<header class="entry-header">
		
  
    <h1 class="article-title entry-title" itemprop="name">
      如何设计组件化流程引擎？
    </h1>
  

	</header>
	<div class="entry-content">
		
    	<p>本文简单介绍下流程引擎以及实现一个最基础功能的组件化的流程引擎。</p>
<a id="more"></a>
<h4 id="核心问题"><a href="#核心问题" class="headerlink" title="核心问题"></a>核心问题</h4><p>什么是流程编排的核心要解决的问题?</p>
<p><code>流程可编排</code>是流程引擎的核心，是解决服务流程的核心；</p>
<p><code>流程定义清晰</code>是流程引擎的关键，只有清晰的流程才能保证编排的可维护性；</p>
<p><code>流程易于扩展</code>是流程引擎的核心竞争力，只有更好的扩展能力才能让流程的编排效率提升；</p>
<h4 id="绕不开的BPM规范"><a href="#绕不开的BPM规范" class="headerlink" title="绕不开的BPM规范"></a>绕不开的BPM规范</h4><p><code>BPM（Business Process Manager、业务流程管理）</code>主要用于管理复杂业务关系以及业务流程。</p>
<p><code>BPMN（Business Process Modeling Notation）</code>是BPM的一种建模语言，BMPN2.0是最新版本。</p>
<p>工作流引擎以<code>Activiti</code>为代表，使用BPMN2.0标准定义进行编排管理；</p>
<p>功能完善、相对重量级的产品如下：</p>
<ul>
<li><a href="https://github.com/kiegroup/jbpm" target="_blank" rel="noopener">https://github.com/kiegroup/jbpm</a></li>
<li><a href="https://github.com/Activiti/Activiti" target="_blank" rel="noopener">https://github.com/Activiti/Activiti</a></li>
<li><a href="https://github.com/Netflix/conductor" target="_blank" rel="noopener">https://github.com/Netflix/conductor</a></li>
<li><a href="https://github.com/flowable/flowable-engine" target="_blank" rel="noopener">https://github.com/flowable/flowable-engine</a></li>
<li><a href="https://camunda.com/" target="_blank" rel="noopener">https://camunda.com/</a></li>
</ul>
<p>功能基本可用，相对轻量级的产品如下：</p>
<ul>
<li><a href="https://github.com/alibaba/SmartEngine" target="_blank" rel="noopener">https://github.com/alibaba/SmartEngine</a></li>
<li><a href="https://github.com/dromara/liteflow" target="_blank" rel="noopener">https://github.com/dromara/liteflow</a></li>
</ul>
<h4 id="BMPN的可视化"><a href="#BMPN的可视化" class="headerlink" title="BMPN的可视化"></a>BMPN的可视化</h4><p>流程编排的可视化是降低编排复杂度的关键，除了传统的XML的编排方式，可视化的编排方式更加易于维护。</p>
<p>这里推荐使用开源的<code>bmpmn-js</code>来实现页面可视化。</p>
<p><a href="https://github.com/bpmn-io/bpmn-js" target="_blank" rel="noopener">https://github.com/bpmn-io/bpmn-js</a></p>
<p>如果需要对其功能点和扩展方式进行进一步的了解，可以在其使用实例中了解扩展的写法。</p>
<p><a href="https://github.com/bpmn-io/bpmn-js-examples" target="_blank" rel="noopener">https://github.com/bpmn-io/bpmn-js-examples</a></p>
<h4 id="如何设计组件化流程引擎？"><a href="#如何设计组件化流程引擎？" class="headerlink" title="如何设计组件化流程引擎？"></a>如何设计组件化流程引擎？</h4><blockquote>
<p>目标: 我们到底要解决什么问题?</p>
</blockquote>
<p>传统的工作流引擎常用于企业内部审批流、工作流等方面，注重业务流程的编排和扩展，</p>
<p>而此次要设计的流程引擎是关注代码逻辑流程的编排，</p>
<p>因此，不考虑使用繁琐的Activiti流程，而采用类似liteflow的方式来实现基础的流程编排功能；</p>
<p><img src="/images/simple-flow-1.jpeg" alt="类图"></p>
<p><strong>流程节点</strong></p>
<p>流程节点是编排的最小单元。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 节点定义 **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IFlowNode</span>&lt;<span class="title">C</span> <span class="keyword">extends</span> <span class="title">IFlowContext</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">exec</span><span class="params">(C context)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>节点能力</strong></p>
<p>节点能力适用于扩展流程节点的功能，例如节点重试，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 重试能力 **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IFlowRetryCapacity</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">retryTimes</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 重试节点定义 **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IFlowRetryNode</span>&lt;<span class="title">C</span> <span class="keyword">extends</span> <span class="title">IFlowContext</span>&gt; <span class="keyword">extends</span> <span class="title">IFlowRetryCapacity</span>, <span class="title">IFlowNode</span>&lt;<span class="title">C</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 重试定义 **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IFlowRetry</span>&lt;<span class="title">C</span> <span class="keyword">extends</span> <span class="title">IFlowContext</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">retry</span><span class="params">(IFlowRetryNode retryNode, C context)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 重试策略 **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractFlowRetry</span> <span class="keyword">implements</span> <span class="title">IFlowRetry</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRetry</span><span class="params">(IFlowRetryNode retryNode, IFlowContext flowContext)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">retry</span><span class="params">(IFlowRetryNode retryNode, IFlowContext flowContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (retryNode.retryTimes() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"FlowRetry start uniqueKey=&#123;&#125; retry=&#123;&#125;"</span>, flowContext.getUniqueKey(), retryNode.getClass().getSimpleName());</span><br><span class="line">        doRetry(retryNode, flowContext);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 基于spring的重试策略 **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringFlowRetry</span> <span class="keyword">extends</span> <span class="title">AbstractFlowRetry</span> <span class="keyword">implements</span> <span class="title">IFlowRetry</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ConcurrentHashMap&lt;Integer, RetryTemplate&gt; retryMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRetry</span><span class="params">(IFlowRetryNode retryNode, IFlowContext flowContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (retryNode.retryTimes() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!retryMap.contains(retryNode.retryTimes())) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                RetryTemplate retryTemplate = RetryTemplate.builder()</span><br><span class="line">                        .maxAttempts(retryNode.retryTimes())</span><br><span class="line">                        .retryOn(Throwable.class)</span><br><span class="line">                        .build();</span><br><span class="line">                retryMap.put(retryNode.retryTimes(), retryTemplate);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        retryMap.get(retryNode.retryTimes()).execute((context) -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">"SpringFlowRetry retry uniqueKey=&#123;&#125; retryNode=&#123;&#125; retryCount=&#123;&#125;"</span>, flowContext.getUniqueKey(),</span><br><span class="line">                    retryNode.getClass().getSimpleName(), context.getRetryCount());</span><br><span class="line">            retryNode.exec(flowContext);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>流程链</strong></p>
<p>流程链用于存储流程节点，也就是编排的作用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowChain</span>&lt;<span class="title">C</span> <span class="keyword">extends</span> <span class="title">IFlowContext</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 流程节点的定义</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Class&lt;? extends IFlowNode&gt;&gt; flowNodeDefinition = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">// 用于节点重试</span></span><br><span class="line">    <span class="keyword">private</span> IFlowRetry&lt;C&gt; flowRetry = <span class="keyword">new</span> SpringFlowRetry();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FlowChain <span class="title">add</span><span class="params">(Class&lt;? extends IFlowNode&gt; definition)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.flowNodeDefinition.add(definition);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isNull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> CollectionUtils.isEmpty(flowNodeDefinition);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEach</span><span class="params">(Function&lt;Class&lt;? extends IFlowNode&gt;, List&lt;IFlowNode&gt;&gt; function)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isNull()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        flowNodeDefinition.forEach(function::apply);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Class&lt;? extends IFlowNode&gt;&gt; getFlowNodes() &#123;</span><br><span class="line">        <span class="keyword">return</span> flowNodeDefinition;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IFlowRetry&lt;C&gt; <span class="title">getFlowRetry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> flowRetry;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>流程定义</strong></p>
<p>流程是由流程链以及执行方法组成。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 流程定义 **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IFlow</span>&lt;<span class="title">C</span> <span class="keyword">extends</span> <span class="title">IFlowContext</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">FlowChain <span class="title">getFlowChain</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行流程</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">(C context)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 流程模板 **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractFlowTemplate</span>&lt;<span class="title">C</span> <span class="keyword">extends</span> <span class="title">IFlowContext</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractFlowScanner</span> <span class="keyword">implements</span> <span class="title">IFlow</span>&lt;<span class="title">C</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> FlowNodeSelector selector = <span class="keyword">new</span> FlowNodeSelector(</span><br><span class="line">            getDefaultImplements(),</span><br><span class="line">            getMutexExtensionImplements(),</span><br><span class="line">            getShareExtensionImplements());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(C context)</span> </span>&#123;</span><br><span class="line">        FlowChain&lt;C&gt; flowChain = getFlowChain();</span><br><span class="line">        <span class="keyword">if</span> (flowChain == <span class="keyword">null</span> || flowChain.isNull()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 流程链的顺序执行</span></span><br><span class="line">        <span class="keyword">for</span> (Object flowNode : flowChain.getFlowNodes()) &#123;</span><br><span class="line">            <span class="comment">// 流程的过滤，通过selector来选择当前上下文需要命中的流程节点</span></span><br><span class="line">            List&lt;IFlowNode&gt; flowNodes = selector.select((Class&lt;? extends IFlowNode&gt;) flowNode, context);</span><br><span class="line">            <span class="keyword">if</span> (CollectionUtils.isNotEmpty(flowNodes)) &#123;</span><br><span class="line">                flowNodes.forEach(bean -&gt; &#123;</span><br><span class="line">                    <span class="comment">// 支持流程节点的重试</span></span><br><span class="line">                    <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> IFlowRetryNode &amp;&amp; ((IFlowRetryNode) bean).retryTimes() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        flowChain.getFlowRetry().retry((IFlowRetryNode) bean, context);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        bean.exec(context);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;Class&lt;? extends IFlowNode&gt;&gt; getFlowNodes() &#123;</span><br><span class="line">        <span class="keyword">return</span> getFlowChain() != <span class="keyword">null</span> ? getFlowChain().getFlowNodes() : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 流程扫描 **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractFlowScanner</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span>, <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Class&lt;? extends IFlowNode&gt;&gt; flowNodes;</span><br><span class="line">    <span class="comment">// 默认流程节点</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;Class&lt;? extends IFlowNode&gt; , List&lt;IFlowNode&gt;&gt; defaultImplements = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">// 互斥流程节点</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;Class&lt;? extends IFlowNode&gt; , List&lt;IFlowNode&gt;&gt; mutexExtensionImplements = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">// 共享流程节点</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;Class&lt;? extends IFlowNode&gt; , List&lt;IFlowNode&gt;&gt; shareExtensionImplements = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">// 支持优先级</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;Class&lt;? extends IFlowNode&gt; , PriorityQueue&lt;PriorityFlowNode&gt;&gt; sharePriorityExtensionImplements = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> Comparator&lt;PriorityFlowNode&gt; comparator = (o1, o2) -&gt; o2.priority - o1.priority;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> List&lt;Class&lt;? extends IFlowNode&gt;&gt; getFlowNodes();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;Class&lt;? extends IFlowNode&gt;, List&lt;IFlowNode&gt;&gt; getDefaultImplements() &#123;</span><br><span class="line">        <span class="keyword">return</span> defaultImplements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;Class&lt;? extends IFlowNode&gt;, List&lt;IFlowNode&gt;&gt; getMutexExtensionImplements() &#123;</span><br><span class="line">        <span class="keyword">return</span> mutexExtensionImplements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;Class&lt;? extends IFlowNode&gt;, List&lt;IFlowNode&gt;&gt; getShareExtensionImplements() &#123;</span><br><span class="line">        <span class="keyword">return</span> shareExtensionImplements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">initFlowNodeImplements</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        flowNodes = getFlowNodes();</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(flowNodes)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String, IFlowNode&gt; beans = applicationContext.getBeansOfType(IFlowNode.class);</span><br><span class="line">        <span class="keyword">if</span> (MapUtils.isEmpty(beans)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        beans.values().stream().forEach(bean -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (Class&lt;? extends IFlowNode&gt; flowNode : flowNodes) &#123;</span><br><span class="line">                <span class="keyword">if</span> (flowNode.isInstance(bean)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (bean.getClass().getAnnotation(DefaultFlowNode.class) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        registerFlowNode(defaultImplements, bean, flowNode);</span><br><span class="line">                        log.info(<span class="string">"AbstractFlowBuilder register default=&#123;&#125;"</span>, bean.getClass().getSimpleName());</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bean.getClass().getAnnotation(ExtensionFlowNode.class) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        ExtensionFlowNode extensionFlowNode = bean.getClass().getAnnotation(ExtensionFlowNode.class);</span><br><span class="line"><span class="comment">//                        registerFlowNode(FlowExtensionType.MUTEX.equals(extensionFlowNode.type())</span></span><br><span class="line"><span class="comment">//                                ? mutexExtensionImplements : shareExtensionImplements, bean, flowNode);</span></span><br><span class="line">                        <span class="keyword">if</span> (FlowExtensionType.MUTEX.equals(extensionFlowNode.type())) &#123;</span><br><span class="line">                            registerFlowNode(mutexExtensionImplements, bean, flowNode);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            registerPriorityFlowNode(bean, flowNode, extensionFlowNode.priority());</span><br><span class="line">                        &#125;</span><br><span class="line">                        log.info(<span class="string">"AbstractFlowBuilder register extension=&#123;&#125;"</span>, bean.getClass().getSimpleName());</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        log.info(<span class="string">"AbstractFlowBuilder register ignore &#123;&#125;"</span>, bean.getClass().getSimpleName());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        refreshShareExtensionImplements();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refreshShareExtensionImplements</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// priority 转 list</span></span><br><span class="line">        <span class="keyword">for</span> (Class&lt;? extends IFlowNode&gt; flowNode : sharePriorityExtensionImplements.keySet()) &#123;</span><br><span class="line">            PriorityQueue&lt;PriorityFlowNode&gt; priorityQueue = sharePriorityExtensionImplements.get(flowNode);</span><br><span class="line">            <span class="keyword">if</span> (priorityQueue != <span class="keyword">null</span>) &#123;</span><br><span class="line">                List&lt;IFlowNode&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                <span class="keyword">while</span> (!priorityQueue.isEmpty()) &#123;</span><br><span class="line">                    list.add(priorityQueue.poll().getFlowNode());</span><br><span class="line">                &#125;</span><br><span class="line">                shareExtensionImplements.put(flowNode, list);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerFlowNode</span><span class="params">(Map&lt;Class&lt;? extends IFlowNode&gt; , List&lt;IFlowNode&gt;&gt; store, IFlowNode bean, Class&lt;? extends IFlowNode&gt; definition)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!store.containsKey(definition)) &#123;</span><br><span class="line">            store.put(definition, <span class="keyword">new</span> ArrayList&lt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">        store.get(definition).add(bean);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerPriorityFlowNode</span><span class="params">(IFlowNode bean, Class&lt;? extends IFlowNode&gt; definition, <span class="keyword">int</span> priority)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!sharePriorityExtensionImplements.containsKey(definition)) &#123;</span><br><span class="line">            sharePriorityExtensionImplements.put(definition, <span class="keyword">new</span> PriorityQueue&lt;&gt;(comparator));</span><br><span class="line">        &#125;</span><br><span class="line">        sharePriorityExtensionImplements.get(definition).add(<span class="keyword">new</span> PriorityFlowNode(bean, priority));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        initFlowNodeImplements();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.applicationContext = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PriorityFlowNode</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> IFlowNode flowNode;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> priority = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PriorityFlowNode</span><span class="params">(IFlowNode flowNode, <span class="keyword">int</span> priority)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.flowNode = flowNode;</span><br><span class="line">            <span class="keyword">this</span>.priority = priority;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>流程扩展</strong></p>
<p>在流程定义中，应该可以发现流程节点会分为默认节点和扩展节点，其中扩展节点又可以分为互斥节点和共享节点；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 扩展类型 **/</span></span><br><span class="line">ffpublic <span class="keyword">enum</span> FlowExtensionType &#123;</span><br><span class="line">    MUTEX, <span class="comment">// 互斥、不同的扩展会相互隔离</span></span><br><span class="line">    SHARE, <span class="comment">// 共享、不同的扩展会相互叠加，通过指定不同的优先级来控制先后的覆盖顺序</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 默认节点 **/</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DefaultFlowNode &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 扩展节点 **/</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ExtensionFlowNode &#123;</span><br><span class="line">    <span class="function">FlowExtensionType <span class="title">type</span><span class="params">()</span> <span class="keyword">default</span> FlowExtensionType.SHARE</span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">priority</span><span class="params">()</span> <span class="keyword">default</span> 1</span>; <span class="comment">// 值越大优先级越高</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 扩展匹配 **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IMatcher</span>&lt;<span class="title">C</span> <span class="keyword">extends</span> <span class="title">IFlowContext</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">match</span><span class="params">(C context)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="待完善的功能点"><a href="#待完善的功能点" class="headerlink" title="待完善的功能点"></a>待完善的功能点</h5><ul>
<li>流程分叉（流程编排过程中存在if-else的问题）</li>
<li>流程持久化</li>
<li>流程重试</li>
<li>xml编排</li>
<li>bpmn可视化编排</li>
</ul>

    
	</div>
	
    
<nav id="article-nav">
  
    <a href="/2022/03/20/view-module-desgin/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          页面组件化的架构设计与思考
        
      </div>
    </a>
  
  
    <a href="/2020/09/01/kafka-replication/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">
        
          Kafka Replication
        
      </div>
    </a>
  
</nav>

  
</article>







</div>

    <!--/div-->
    <div class="mb-search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:simyy.cn">
  </form>
</div>
<footer id="footer">
	<h1 class="footer-blog-title">
		<a href="/">simyy</a>
	</h1>
    &nbsp;&nbsp;
	<span class="copyright">
		&copy; 2022 simyy  Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
	</span>
</footer>

    

<script src="https://cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>
