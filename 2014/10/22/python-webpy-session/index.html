<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>webpy中的session实现 | Simple Life</title>
  <meta name="description" content="A blog of simyy" />
  <meta name="keywords" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/">
  <link rel="alternate" href="/atom.xml" title="Simple Life">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="虽然工作中使用的是django，但是自己并不喜欢那种大而全的东西~什么都给你准备好了，自己好像一个机器人一样赶着重复的基本工作，从在学校时候就养成了追究原理的习惯，从而有了这篇session的使用和说明。">
<meta name="keywords" content="framework,python">
<meta property="og:type" content="article">
<meta property="og:title" content="webpy中的session实现">
<meta property="og:url" content="http://simyy.com/2014/10/22/python-webpy-session/index.html">
<meta property="og:site_name" content="Simple Life">
<meta property="og:description" content="虽然工作中使用的是django，但是自己并不喜欢那种大而全的东西~什么都给你准备好了，自己好像一个机器人一样赶着重复的基本工作，从在学校时候就养成了追究原理的习惯，从而有了这篇session的使用和说明。">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2017-04-08T09:27:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="webpy中的session实现">
<meta name="twitter:description" content="虽然工作中使用的是django，但是自己并不喜欢那种大而全的东西~什么都给你准备好了，自己好像一个机器人一样赶着重复的基本工作，从在学校时候就养成了追究原理的习惯，从而有了这篇session的使用和说明。">
    
  <link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href='//cdn.bootcss.com/node-waves/0.7.5/waves.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
</head>

<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script> 
  <header class="l_header">
	<div class='wrapper'>
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href='/' >
				Simple Life
			</a>
			<div class='menu'>
				<ul class='h-list'>
					
						<li>
							<a class='flat-box nav-home' href='/'>
								Home
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-archives' href='/archives'>
								Archives
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-about' href='/about'>
								About
							</a>
						</li>
					
				</ul>
				<div class='underline'></div>
			</div>
			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<span class="icon icon-search"></span>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a href='javascript:void(0)'><span class="icon icon-search flat-box"></span></a></li>
				
				<li class='s-menu'><a href='javascript:void(0)'><span class="icon icon-menu flat-box"></span></a></li>
			</ul>
		</div>
		
		<div class='nav-sub container container--flex'>
			<a class="logo" class="flat-box" href='javascript:void(0)'>
				Word of Forks
			</a>

			<ul class='switcher h-list'>
				<li class='s-comment'><a href='javascript:void(0)'><span class="icon icon-chat_bubble_outline flat-box"></span></a></li>
				<li class='s-top'><a href='javascript:void(0)'><span class="icon icon-arrow_upward flat-box"></span></a></li>
				<li class='s-toc'><a href='javascript:void(0)'><span class="icon icon-format_list_numbered flat-box"></span></a></li>
			</ul>
		</div>
	</div>
</header>
<aside class="menu-phone">
	<nav>
		
			<a href="/" class="nav-home nav">
				Home
			</a>
		
			<a href="/archives" class="nav-archives nav">
				Archives
			</a>
		
			<a href="/about" class="nav-about nav">
				About
			</a>
		
	</nav>
</aside>

    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container clearfix'>
      <div class='l_main'>
        <article id="post-python-webpy-session"
  class="post white-box article-type-post"
  itemscope itemprop="blogPost">
	<section class='meta'>
	<h2 class="title">
  	<a href="/2014/10/22/python-webpy-session/">
    	webpy中的session实现
    </a>
  </h2>
	<time>
	  10月 22, 2014
	</time>
	
    
    <div class='cats'>
        <a href="/categories/python/">python</a>
    </div>

	</section>
	
		<section class="toc-wrapper"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#webpy中的session"><span class="toc-number">1.</span> <span class="toc-text">webpy中的session</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#webpy的子程序中使用session"><span class="toc-number">2.</span> <span class="toc-text">webpy的子程序中使用session</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#session-id"><span class="toc-number">3.</span> <span class="toc-text">session id</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#session的结构"><span class="toc-number">4.</span> <span class="toc-text">session的结构</span></a></li></ol></section>
	
	<section class="article typo">
  	<div class="article-entry" itemprop="articleBody">
    	<p>虽然工作中使用的是django，但是自己并不喜欢那种大而全的东西~什么都给你准备好了，自己好像一个机器人一样赶着重复的基本工作，从在学校时候就养成了追究原理的习惯，从而有了这篇session的使用和说明。<br><a id="more"></a></p>
<h2 id="webpy中的session"><a href="#webpy中的session" class="headerlink" title="webpy中的session"></a>webpy中的session</h2><p>下面为官方的例子，用session来存储页面访问的次数，从而实现对访问次数的记录。</p>
<p>需要注意的是，官方说明在调试情况下，session并不能正常的运行，所以需要在非调试摸下测试，那么就有了下面的这个例子。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> web</span><br><span class="line"></span><br><span class="line"><span class="comment">#非调试模式</span></span><br><span class="line">web.config.debug = <span class="keyword">False</span></span><br><span class="line">urls = (</span><br><span class="line">    <span class="string">"/count"</span>, <span class="string">"count"</span>,</span><br><span class="line">    <span class="string">"/reset"</span>, <span class="string">"reset"</span></span><br><span class="line">)</span><br><span class="line">app = web.application(urls, locals())</span><br><span class="line">session = web.session.Session(app, web.session.DiskStore(<span class="string">'sessions'</span>), initializer=&#123;<span class="string">'count'</span>: <span class="number">0</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">count</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GET</span><span class="params">(self)</span>:</span></span><br><span class="line">        session.count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> str(session.count)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">reset</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GET</span><span class="params">(self)</span>:</span></span><br><span class="line">        session.kill()</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>
<p>在官方文档中，对上述debug模式的现象给出了这样的解释：</p>
<blockquote>
<p>session与调试模试下的重调用相冲突(有点类似firefox下著名的Firebug插件，使用Firebug插件分析网页时，会在火狐浏览器之外单独对该网页发起请求，所以相当于同时访问该网页两次)<br>　　<br>为了解决上述问题，官方给出了进一步的解决方法，如下</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> web</span><br><span class="line"></span><br><span class="line">urls = (<span class="string">"/"</span>, <span class="string">"hello"</span>)</span><br><span class="line"></span><br><span class="line">app = web.application(urls, globals())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> web.config.get(<span class="string">'_session'</span>) <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">    session = web.session.Session(app, web.session.DiskStore(<span class="string">'sessions'</span>), &#123;<span class="string">'count'</span>: <span class="number">0</span>&#125;)</span><br><span class="line">    web.config._session = session</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    session = web.config._session</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">hello</span>:</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">GET</span><span class="params">(self)</span>:</span></span><br><span class="line">       <span class="keyword">print</span> <span class="string">'session'</span>, session</span><br><span class="line">       session.count += <span class="number">1</span></span><br><span class="line">       <span class="keyword">return</span> <span class="string">'Hello, %s!'</span> % session.count</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">   app.run()</span><br></pre></td></tr></table></figure>
<p>由于web.session.Session会重载两次，但是在上面的_session并不会重载两次，因为上面多了一个判断_session是否存在于web.config中。</p>
<p>其实，在web.py文件中，定义了config，而Storage在下面的图中并没有特殊的结果，像字典一样~</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#web.py</span><br><span class="line">config = storage()</span><br><span class="line"></span><br><span class="line">#utils.py</span><br><span class="line">storage = Storage</span><br></pre></td></tr></table></figure>
<h2 id="webpy的子程序中使用session"><a href="#webpy的子程序中使用session" class="headerlink" title="webpy的子程序中使用session"></a>webpy的子程序中使用session</h2><p>虽然官方文档中提到，只能在主程序中使用session，但是通过添加<code>__init__.py</code>可以条用到该页面的session，也就是说一样使用session。</p>
<p>官方给出的方法更加合理化一点，通过应用处理器，加载钩子(loadhooks)</p>
<p>在webpy中，应用处理器为<code>app.add_processor(my_processor)</code>，下面的代码添加到上述的完整例子中，可以再处理请求前和处理请求后分别条用<code>my_loadhook()``和my_unloadhook()</code>,</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_loadhook</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"my load hook"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_unloadhook</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"my unload hook"</span></span><br><span class="line"></span><br><span class="line">app.add_processor(web.loadhook(my_loadhook))</span><br><span class="line">app.add_processor(web.unloadhook(my_unloadhook))</span><br></pre></td></tr></table></figure>
<p>从而，可以再web.loadhook()中加载session信息，在处理之前从web.ctx.session中获取session了，甚至可以在应用处理器中添加认证等操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#main.py</span><br><span class="line">def session_hook():</span><br><span class="line">　　web.ctx.session = session</span><br><span class="line">app.add_processor(web.loadhook(session_hook))</span><br><span class="line"></span><br><span class="line">#views.py</span><br><span class="line">class edit:</span><br><span class="line">    def GET(self):</span><br><span class="line">        try:</span><br><span class="line">            session = web.ctx.session</span><br><span class="line">            username = session.username</span><br><span class="line">            if not username:</span><br><span class="line">                return web.redirect(&apos;/login&apos;)</span><br><span class="line">        except Exception as e:</span><br><span class="line">            return web.redirect(&apos;/login&apos;)</span><br><span class="line">        return render_template(&apos;edit.html&apos;)</span><br></pre></td></tr></table></figure>
<h2 id="session-id"><a href="#session-id" class="headerlink" title="session id"></a>session id</h2><p>对于服务器来说，怎样才能区分不同客户端呢，怎样才能区分不同客户端的session呢？</p>
<p>是通过sessionid来实现的，最初我还傻傻的分不清session和cookie，以及不同用户之间的信息室如何分配的！</p>
<p>生成sessionid的代码段，其中包含了随机数、时间、ip以及秘钥,</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_generate_session_id</span><span class="params">(self)</span>:</span></span><br><span class="line">	<span class="string">"""Generate a random id for session"""</span></span><br><span class="line">	<span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">		rand = os.urandom(<span class="number">16</span>)</span><br><span class="line">		now = time.time()</span><br><span class="line">		secret_key = self._config.secret_key</span><br><span class="line">		session_id = sha1(<span class="string">"%s%s%s%s"</span> % (rand, now, utils.safestr(web.ctx.ip), secret_key))</span><br><span class="line">		session_id = session_id.hexdigest()</span><br><span class="line">		<span class="keyword">if</span> session_id <span class="keyword">not</span> <span class="keyword">in</span> self.store:</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">return</span> session_id</span><br></pre></td></tr></table></figure>
<p>　　<br>在客户端访问服务器时，服务器会根据上述信息来计算一个针对客户端唯一的sessionid，并通过cookie保存在客户端中。</p>
<p>客户端用cookie保存了sessionID，当我们请求服务器的时候，会把这个sessionID一起发给服务器，服务器会到内存中搜索对应的sessionID，如果找到了对应的 sessionID，说明我们处于登录状态，有相应的权限；如果没有找到对应的sessionID，这说明：要么是我们把浏览器关掉了（后面会说明为什 么），要么session超时了（没有请求服务器超过20分钟），session被服务器清除了，则服务器会给你分配一个新的sessionID。你得重新登录并把这个新的sessionID保存在cookie中。 </p>
<h2 id="session的结构"><a href="#session的结构" class="headerlink" title="session的结构"></a>session的结构</h2><p>上面提到了session在webpy中式一种dict的方式存储，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Session</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""Session management for web.py</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    __slots__ = [</span><br><span class="line">        <span class="string">"store"</span>, <span class="string">"_initializer"</span>, <span class="string">"_last_cleanup_time"</span>, <span class="string">"_config"</span>, <span class="string">"_data"</span>, </span><br><span class="line">        <span class="string">"__getitem__"</span>, <span class="string">"__setitem__"</span>, <span class="string">"__delitem__"</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, app, store, initializer=None)</span>:</span></span><br><span class="line">        self.store = store</span><br><span class="line">        self._initializer = initializer</span><br><span class="line">        self._last_cleanup_time = <span class="number">0</span></span><br><span class="line">        self._config = utils.storage(web.config.session_parameters)</span><br><span class="line">        self._data = utils.threadeddict()</span><br><span class="line">        </span><br><span class="line">        self.__getitem__ = self._data.__getitem__</span><br><span class="line">        self.__setitem__ = self._data.__setitem__</span><br><span class="line">        self.__delitem__ = self._data.__delitem__</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> app:</span><br><span class="line">            app.add_processor(self._processor)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__contains__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> name <span class="keyword">in</span> self._data</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> getattr(self._data, name)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, name, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">in</span> self.__slots__:</span><br><span class="line">            object.__setattr__(self, name, value)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            setattr(self._data, name, value)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delattr__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        delattr(self._data, name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_processor</span><span class="params">(self, handler)</span>:</span></span><br><span class="line">        <span class="string">"""Application processor to setup session for every request"""</span></span><br><span class="line">        self._cleanup()</span><br><span class="line">        self._load()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> handler()</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            self._save()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_load</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Load the session from the store, by the id from cookie"""</span></span><br><span class="line">        cookie_name = self._config.cookie_name</span><br><span class="line">        cookie_domain = self._config.cookie_domain</span><br><span class="line">        cookie_path = self._config.cookie_path</span><br><span class="line">        httponly = self._config.httponly</span><br><span class="line">        self.session_id = web.cookies().get(cookie_name)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># protection against session_id tampering</span></span><br><span class="line">        <span class="keyword">if</span> self.session_id <span class="keyword">and</span> <span class="keyword">not</span> self._valid_session_id(self.session_id):</span><br><span class="line">            self.session_id = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">        self._check_expiry()</span><br><span class="line">        <span class="keyword">if</span> self.session_id:</span><br><span class="line">            d = self.store[self.session_id]</span><br><span class="line">            self.update(d)</span><br><span class="line">            self._validate_ip()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.session_id:</span><br><span class="line">            self.session_id = self._generate_session_id()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> self._initializer:</span><br><span class="line">                <span class="keyword">if</span> isinstance(self._initializer, dict):</span><br><span class="line">                    self.update(deepcopy(self._initializer))</span><br><span class="line">                <span class="keyword">elif</span> hasattr(self._initializer, <span class="string">'__call__'</span>):</span><br><span class="line">                    self._initializer()</span><br><span class="line"> </span><br><span class="line">        self.ip = web.ctx.ip</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_check_expiry</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># check for expiry</span></span><br><span class="line">        <span class="keyword">if</span> self.session_id <span class="keyword">and</span> self.session_id <span class="keyword">not</span> <span class="keyword">in</span> self.store:</span><br><span class="line">            <span class="keyword">if</span> self._config.ignore_expiry:</span><br><span class="line">                self.session_id = <span class="keyword">None</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> self.expired()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_validate_ip</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># check for change of IP</span></span><br><span class="line">        <span class="keyword">if</span> self.session_id <span class="keyword">and</span> self.get(<span class="string">'ip'</span>, <span class="keyword">None</span>) != web.ctx.ip:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self._config.ignore_change_ip:</span><br><span class="line">               <span class="keyword">return</span> self.expired() </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_save</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.get(<span class="string">'_killed'</span>):</span><br><span class="line">            self._setcookie(self.session_id)</span><br><span class="line">            self.store[self.session_id] = dict(self._data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self._setcookie(self.session_id, expires=<span class="number">-1</span>)</span><br><span class="line">            </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_setcookie</span><span class="params">(self, session_id, expires=<span class="string">''</span>, **kw)</span>:</span></span><br><span class="line">        cookie_name = self._config.cookie_name</span><br><span class="line">        cookie_domain = self._config.cookie_domain</span><br><span class="line">        cookie_path = self._config.cookie_path</span><br><span class="line">        httponly = self._config.httponly</span><br><span class="line">        secure = self._config.secure</span><br><span class="line">        web.setcookie(cookie_name, session_id, expires=expires, domain=cookie_domain, httponly=httponly, secure=secure, path=cookie_path)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_generate_session_id</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Generate a random id for session"""</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            rand = os.urandom(<span class="number">16</span>)</span><br><span class="line">            now = time.time()</span><br><span class="line">            secret_key = self._config.secret_key</span><br><span class="line">            session_id = sha1(<span class="string">"%s%s%s%s"</span> %(rand, now, utils.safestr(web.ctx.ip), secret_key))</span><br><span class="line">            session_id = session_id.hexdigest()</span><br><span class="line">            <span class="keyword">if</span> session_id <span class="keyword">not</span> <span class="keyword">in</span> self.store:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">return</span> session_id</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_valid_session_id</span><span class="params">(self, session_id)</span>:</span></span><br><span class="line">        rx = utils.re_compile(<span class="string">'^[0-9a-fA-F]+$'</span>)</span><br><span class="line">        <span class="keyword">return</span> rx.match(session_id)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_cleanup</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Cleanup the stored sessions"""</span></span><br><span class="line">        current_time = time.time()</span><br><span class="line">        timeout = self._config.timeout</span><br><span class="line">        <span class="keyword">if</span> current_time - self._last_cleanup_time &gt; timeout:</span><br><span class="line">            self.store.cleanup(timeout)</span><br><span class="line">            self._last_cleanup_time = current_time</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">expired</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Called when an expired session is atime"""</span></span><br><span class="line">        self._killed = <span class="keyword">True</span></span><br><span class="line">        self._save()</span><br><span class="line">        <span class="keyword">raise</span> SessionExpired(self._config.expired_message)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">kill</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Kill the session, make it no longer available"""</span></span><br><span class="line">        <span class="keyword">del</span> self.store[self.session_id]</span><br><span class="line">        self._killed = <span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<p>在webpy的session中，存储方式包括两种DiskStore和DBStore，分别为硬盘存储和数据库存储。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DiskStore</span><span class="params">(Store)</span>:</span></span><br><span class="line">	<span class="string">"""</span></span><br><span class="line"><span class="string">	Store for saving a session on disk</span></span><br><span class="line"><span class="string">	"""</span></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DBStore</span><span class="params">(Store)</span>:</span></span><br><span class="line">	<span class="string">"""</span></span><br><span class="line"><span class="string">	Store for saving a session in database</span></span><br><span class="line"><span class="string">	Needs a table with following columns:</span></span><br><span class="line"><span class="string">		session_id CHAR(128) UNIQUE NOT NULL,</span></span><br><span class="line"><span class="string">		atime DATATIME NOT NULL DEFAULT current_timestamp,</span></span><br><span class="line"><span class="string">		data TEXT</span></span><br><span class="line"><span class="string">	"""</span></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">```　　</span><br><span class="line"></span><br><span class="line">而session的存储也可以看出来，把sessionid作为key来存储session信息</span><br><span class="line"></span><br><span class="line">```python</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_save</span><span class="params">(self)</span>:</span></span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> self.get(<span class="string">'_killed'</span>):</span><br><span class="line">		self._set_cookie(self.session_id)</span><br><span class="line">		self.store[self.session_id] = dict(self._data)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		self._setcookie(self.session_id, expires=<span class="number">-1</span>)</span><br></pre></td></tr></table></figure>
<p>　　</p>
<p>参考</p>
<p><a href="http://doc.outofmemory.cn/python/webpy-cookbook/" target="_blank" rel="external">http://doc.outofmemory.cn/python/webpy-cookbook/</a></p>
<p><a href="http://webpy.org/docs/0.3/tutorial" target="_blank" rel="external">http://webpy.org/docs/0.3/tutorial</a></p>

  	</div>
	  
	  <div class="article-tags tags">
      
        <a href="/tags/framework/">framework</a>
      
        <a href="/tags/python/">python</a>
      
	  </div>
    
		
	
		<div class="art-item-footer">
				
					<span class="art-item-left"><i class="icon icon-chevron-thin-left"></i>prev：<a href="/2014/11/01/python-list/" rel="prev"  title="python 序列">
						python 序列 
					</a></span>
				
				
					<span class="art-item-right">next：<a href="/2014/10/22/python-deamon/" rel="next"  title="python 守护进程">
						python 守护进程
					</a><i class="icon icon-chevron-thin-right"></i></span>
				
		</div>
	
	</section>
	
</article>
<script>
	window.subData = {
		title: 'webpy中的session实现',
		tools: true
	}
</script>

      </div>
      <aside class='l_side'>
        
  <section class='m_widget about'>

<div class='header'>simyy</div>
<div class='content'>
<div class='desc'>Tempora mutantur, nos et mutamur in illis ...</div>
</div>
</section>

  <section class='m_widget links'>
<div class='header'>Links</div>
<div class='content'>
    <ul class="entry">
    
        <li><a class="flat-box" target="_blank" href="https://www.cnblogs.com/coder2012">
            <div class='name'>cnblog</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="https://qiuar.com">
            <div class='name'>qiuar</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="http://github.com/simyy">
            <div class='name'>github</div>
        </a></li>
    
    </ul>
</div>
</section>

  <section class='m_widget categories'>
<div class='header'>Categories</div>
<div class='content'>
    
    <ul class="entry">
    
        <li><a class="flat-box" href="/categories/algorithm/"><div class='name'>algorithm</div><div class='badget'>12</div></a></li>
    
        <li><a class="flat-box" href="/categories/c/"><div class='name'>c</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/categories/cache/"><div class='name'>cache</div><div class='badget'>9</div></a></li>
    
        <li><a class="flat-box" href="/categories/cs/"><div class='name'>cs</div><div class='badget'>8</div></a></li>
    
        <li><a class="flat-box" href="/categories/db/"><div class='name'>db</div><div class='badget'>8</div></a></li>
    
        <li><a class="flat-box" href="/categories/fe/"><div class='name'>fe</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/categories/go/"><div class='name'>go</div><div class='badget'>2</div></a></li>
    
        <li><a class="flat-box" href="/categories/java/"><div class='name'>java</div><div class='badget'>8</div></a></li>
    
        <li><a class="flat-box" href="/categories/mq/"><div class='name'>mq</div><div class='badget'>6</div></a></li>
    
        <li><a class="flat-box" href="/categories/php/"><div class='name'>php</div><div class='badget'>2</div></a></li>
    
        <li><a class="flat-box" href="/categories/python/"><div class='name'>python</div><div class='badget'>20</div></a></li>
    
        <li><a class="flat-box" href="/categories/web/"><div class='name'>web</div><div class='badget'>4</div></a></li>
    
        <li><a class="flat-box" href="/categories/分布式/"><div class='name'>分布式</div><div class='badget'>1</div></a></li>
    
    </ul>
    
</div>
</section>

  
<div class="m_widget tagcloud">
    <div class="header">Tags</div>
    <div class='content'>
        <a href="/tags/algorithm/" style="font-size: 18.5px; color: #202020">algorithm</a> <a href="/tags/c/" style="font-size: 14px; color: #808080">c</a> <a href="/tags/css/" style="font-size: 14px; color: #808080">css</a> <a href="/tags/framework/" style="font-size: 16.25px; color: #505050">framework</a> <a href="/tags/gc/" style="font-size: 14px; color: #808080">gc</a> <a href="/tags/go/" style="font-size: 14.75px; color: #707070">go</a> <a href="/tags/java/" style="font-size: 19.25px; color: #101010">java</a> <a href="/tags/jetty/" style="font-size: 14px; color: #808080">jetty</a> <a href="/tags/linux/" style="font-size: 15.5px; color: #606060">linux</a> <a href="/tags/maven/" style="font-size: 14px; color: #808080">maven</a> <a href="/tags/memcache/" style="font-size: 15.5px; color: #606060">memcache</a> <a href="/tags/mysql/" style="font-size: 17.75px; color: #303030">mysql</a> <a href="/tags/orm/" style="font-size: 14.75px; color: #707070">orm</a> <a href="/tags/php/" style="font-size: 14.75px; color: #707070">php</a> <a href="/tags/python/" style="font-size: 20px; color: #000">python</a> <a href="/tags/rabbitmq/" style="font-size: 17.75px; color: #303030">rabbitmq</a> <a href="/tags/redis/" style="font-size: 17.75px; color: #303030">redis</a> <a href="/tags/rpc/" style="font-size: 14px; color: #808080">rpc</a> <a href="/tags/spider/" style="font-size: 14px; color: #808080">spider</a> <a href="/tags/spring/" style="font-size: 15.5px; color: #606060">spring</a> <a href="/tags/tcp/" style="font-size: 14.75px; color: #707070">tcp</a> <a href="/tags/web/" style="font-size: 14px; color: #808080">web</a> <a href="/tags/中文分词/" style="font-size: 14px; color: #808080">中文分词</a> <a href="/tags/分布式/" style="font-size: 14px; color: #808080">分布式</a> <a href="/tags/机器学习/" style="font-size: 17px; color: #404040">机器学习</a> <a href="/tags/编译原理/" style="font-size: 14.75px; color: #707070">编译原理</a>
    </div>
</div>



      </aside>
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  <footer id="footer" class="clearfix">

	<div class="social-wrapper">
  	
      
        <a href="https://github.com/simyy" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="/atom.xml" class="social rss"
          target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
      
    
  </div>
  
  <div>Theme <a href='https://github.com/stkevintan/hexo-theme-material-flow' class="codename">MaterialFlow</a> designed by <a href="http://keyin.me/" target="_blank">Kevin Tan</a>.</div>
  
</footer>


  <script>setLoadingBarProgress(80);</script>
  

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src='//cdn.bootcss.com/node-waves/0.7.5/waves.min.js'></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>
<script src="/js/jquery.fitvids.js"></script>
<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "hexo";
  var ROOT = "/"||"/";
  if(!ROOT.endsWith('/'))ROOT += '/';
</script>
<script src="/js/search.js"></script>
<script src="/js/app.js"></script>


  <script>setLoadingBarProgress(100);</script>
</body>
</html>
